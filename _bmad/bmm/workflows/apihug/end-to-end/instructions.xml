<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language}</critical>
  <critical>Generate all documents in {document_output_language}</critical>

  <critical>üìñ Read the End-to-End Pipeline Bible: {bible}</critical>
  <critical>Respect ApiHug Source Set Convention: generated code in `src/generated/main/{api,domain,wire,mcp,cloud}` (read-only), handwritten code in `src/main/{java,trait,proto}`. NEVER modify src/generated/ - regenerated by `wire` task!</critical>

  <step n="1" goal="Run wire and start application">
    <output>**üöÄ Phase 1: Build & Start Application ({module_gradle_module})**</output>

    <action>Run command: ./gradlew {module_gradle_module}:bootRun</action>

    <action>Wait for application startup and check logs for:
      - "Started" message
      - No ERROR-level exceptions during startup
    </action>

    <check if="application fails to start">
      <output>‚ùå Application failed to start</output>
      <action>Check:
        - Proto compilation errors (wire task runs automatically)
        - Port conflicts
        - application.yml configuration
        - Database connectivity (if applicable)
        - Full startup logs</action>
      <abort/>
    </check>

    <output>‚úÖ Application started successfully on http://localhost:18899</output>
  </step>

  <step n="2" goal="Validate OAS and metadata endpoints">
    <output>**üìò Phase 2: Validate OAS & metadata**</output>

    <action>Validate endpoints:
      - OAS: http://localhost:18899/v3/api-docs
      - Errors: http://localhost:18899/hope/meta/errors
      - Authorities: http://localhost:18899/hope/meta/authorities
      - Dictionaries: http://localhost:18899/hope/meta/dictionaries
      - Versions: http://localhost:18899/hope/meta/versions
    </action>

    <action>For OAS:
      1. Ensure the document is accessible
      2. Check that paths/methods match designed APIs
      3. Verify schemas for request/response DTOs
      4. Confirm enums and constraints are correct</action>

    <action>For error metadata:
      1. Ensure all error codes are unique
      2. Verify message/message2
      3. Check HTTP status mapping, category, and severity</action>

    <action>For authorities:
      1. Ensure authorities list matches {authority_enum_class}
      2. Verify naming conventions and descriptions</action>

    <output>‚úÖ OAS and metadata endpoints validated</output>
  </step>

  <step n="3" goal="Exercise key APIs">
    <output>**üß™ Phase 3: Exercise key APIs**</output>

    <ask>Provide 1‚Äì3 core API scenarios to test (success + error cases). You can skip for now by answering "skip".</ask>
    <action>Set {{api_scenarios}} = user input</action>

    <check if="{{api_scenarios}} == 'skip'">
      <output>‚è≠Ô∏è Skipping manual API exercises (not recommended for production readiness)</output>
    </check>

    <check if="{{api_scenarios}} != 'skip'">
      <action>For each scenario in {{api_scenarios}}:
        1. Build curl/Postman style requests
        2. Execute scenario
        3. Compare actual responses with expected:
           - HTTP status
           - Response body structure
           - Error codes (for negative cases)
      </action>
      <output>‚úÖ Core API scenarios exercised</output>
    </check>
  </step>

  <step n="4" goal="Run automated tests">
    <output>**‚úÖ Phase 4: Run tests ({module_gradle_module}:test)**</output>

    <action>Run command: ./gradlew {module_gradle_module}:test</action>

    <check if="tests fail">
      <output>‚ùå Tests failed for {module_gradle_module}</output>
      <action>Inspect test reports under {test_report_path} and test logs for failures.</action>
      <abort/>
    </check>

    <output>‚úÖ Tests executed successfully. Check report at {test_report_path}</output>
  </step>

  <step n="5" goal="Summarize end-to-end results">
    <output>**üìù Phase 5: Summarize end-to-end pipeline**</output>

    <action>Generate summary document at {module_path}/docs/end-to-end-{{domain_name}}-{{module_name}}.md</action>

    <output file="{module_path}/docs/end-to-end-{{domain_name}}-{{module_name}}.md">
# End-to-End Pipeline Summary

**Domain**: {{domain_name}}
**Module**: {{module_name}}
**Date**: {{date}}
**Executor**: {{user_name}}

## ‚úÖ Phases Status

- Application startup: PASSED
- OAS & metadata validation: PASSED
- API exercises: {{api_scenarios}}
- Tests: PASSED

## üîç Key Endpoints

- Application: http://localhost:18899/
- OAS: http://localhost:18899/v3/api-docs
- Errors: http://localhost:18899/hope/meta/errors
- Authorities: http://localhost:18899/hope/meta/authorities
- Dictionaries: http://localhost:18899/hope/meta/dictionaries
- Versions: http://localhost:18899/hope/meta/versions

## üìå Notes

(Add any findings, issues, or TODOs here.)

---
*Generated by ApiHug End-to-End Workflow*
    </output>

    <output>‚úÖ **End-to-end pipeline completed**

Summary saved to: {module_path}/docs/end-to-end-{{domain_name}}-{{module_name}}.md
    </output>
  </step>

</workflow>
